{% extends "common/base.html" %}
{% block content %}
    <div class="row">
        <div class="col">
            <h1>나의 주식</h1>

            <form id="form-mystock-add" action="">
                <input type="text" name="stk_code" placeholder="종목코드" required>
                <button type="submit" class="btn btn-primary">Add</button>
            </form>
            <div id="list-area">
            </div>        
        </div>
        <div class="col">
            <h1>WebSocket Chat</h1>
            <form action="" onsubmit="sendMessage(event)">
                <input type="text" id="messageText" autocomplete="off"/>
                <button>Send</button>
            </form>
            <ul id="messages">
            </ul>            
        </div>
    </div>
    {% raw %}
    <script id="mystock_list_template" type="text/x-handlebars-template">
    <table>
        <thead>
            <tr>
                <th>종류</th>
                <th>종목코드</th>
                <th>종목명</th>
                <th>동작</th>
            </tr>
        </thead>
        <tbody>
            {{#each list}}
            <tr>
                <td>{{this.stk_types}}</td>
                <td>{{this.stk_code}}</td>
                <td>{{this.stk_name}}</td>
                <td><button class="btnDelete btn btn-danger" data-id="{{this._id}}">삭제</button></td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>
{% endraw %}
{% endblock %}
{% block script %}
{% raw %}
    <script>
            var ws = new WebSocket("ws://localhost:8000/ws");
            ws.onmessage = function(event) {
                var messages = document.getElementById('messages')
                var message = document.createElement('li')
                var content = document.createTextNode(event.data)
                message.appendChild(content)
                messages.appendChild(message)
            };

            function sendMessage(event) {
                var input = document.getElementById("messageText")
                ws.send(input.value)
                input.value = ''
                event.preventDefault()
            }

        function display_mystocks() {
            fetch("/api/v1/mystock")
            .then(response => response.json())
            .then(data => {
                $("#list-area").empty();
                var template = Handlebars.compile($("#mystock_list_template").html());
                $("#list-area").html(template({list: data}));
                // data.forEach(function(item) {
                //     $("#list-area").append("<div>" + item.stk_code + " " + item.stk_name +"</div>");
                // });
            })
            .catch(error => {
                console.log(error);
            });
        }
        $(document).ready(function() {
            $("#form-mystock-add").submit(function() {
                stk_code = $(this).find("input[name='stk_code']").val();
                data = {
                    "stk_code": stk_code,
                    "stk_types": ["관심"]
                }
                fetch("/api/v1/mystock/add", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify(data) // Add any data you want to send in the body
                })
                .then(response => response.json())
                .then(data => {
                    display_mystocks()
                })
                .catch(error => {
                    console.log(error);
                });
                return false;
            });
            $('#list-area').on('click', '.btnDelete', function(e){
                e.stopPropagation();
                var id = $(this).data('id');
                fetch("/api/v1/mystock/delete/" + id, {
                    method: "DELETE",
                    headers: {
                        "Content-Type": "application/json"
                    }
                }).then(response => response.json())
                .then(data => {
                    display_mystocks();
                }).catch(error => {
                    console.log(error);
                });
            })
            display_mystocks();
        });
    </script>
{% endraw %}
{% endblock %}