{% extends "common/base.html" %}
{% block content %}
    <div class="row">
        <div class="col">
            <h1>나의 주식</h1>

            <form id="form-mystock-add" action="">
                <input type="text" name="stk_code" placeholder="종목코드" required>
                <button type="submit" id="addStkCode" class="btn btn-primary"><i class="bi bi-plus"></i> 추가</button>
            </form>
            <div id="list-area">
            </div>        
        </div>
        <div class="col">
            <h1>WebSocket Chat</h1>
            <form action="" onsubmit="sendMessage(event)">
                <input type="text" id="messageText" autocomplete="off"/>
                <button>Send</button>
            </form>
            <ul id="messages">
            </ul>            
        </div>
    </div>
    {% raw %}
    <script id="mystock_list_template" type="text/x-handlebars-template">
    <table>
        <thead>
            <tr>
                <th>종류</th>
                <th>종목코드</th>
                <th>종목명</th>
                <th>현재가</th>
                <th>동작</th>
            </tr>
        </thead>
        <tbody>
            {{#each list}}
            <tr>
                <td>{{this.stk_types}}</td>
                <td>{{goNaver this.stk_code}}</td>
                <td>{{this.stk_name}}</td>
                <td id="cost-{{this.stk_code}}">-</td>
                <td>
                    <button class="btnDelete btn btn-secondary" data-id="{{this._id}}" title="관심..삭제"><i class="bi bi-dash"></i></button>
                    <button class="btnCurrentCost btn btn-success" data-stk-code="{{this.stk_code}}"><img src="public/images/korean-won.svg" alt="아이콘" width="20" height="20"></button>
                    <button class="btnBuy btn btn-danger" data-stk-code="{{this.stk_code}}">買</button>
                    <button class="btnSell btn btn-primary" data-stk-code="{{this.stk_code}}">賣</button>
                </td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>
{% endraw %}
{% endblock %}
{% block script %}
{% raw %}
<script>
    var ws = new WebSocket("ws://localhost:8000/ws");
    ws.onmessage = function(event) {
        var messages = document.getElementById('messages')
        var message = document.createElement('li')
        var content = document.createTextNode(event.data)
        message.appendChild(content)
        messages.appendChild(message)
    };

    function sendMessage(event) {
        var input = document.getElementById("messageText")
        ws.send(input.value)
        input.value = ''
        event.preventDefault()
    }

    function display_mystocks() {
        fetch("/api/v1/mystock")
        .then(response => response.json())
        .then(data => {
            $("#list-area").empty();
            var template = Handlebars.compile($("#mystock_list_template").html());
            $("#list-area").html(template({list: data}));
        })
        .catch(error => {
            console.log(error);
        });
    }
    $(document).ready(function() {
        //현재가 조회
        $('#list-area').on('click', '.btnCurrentCost', function(e){
            e.preventDefault();
            debugger;
            const stk_code = $(this).data('stk-code');
            fetchData("/api/v1/kis/current-cost/" + stk_code)
            .then(data => {
                console.log(data);
                const cost = JuliaUtil.displayMoney(data.cost)
                $('#cost-' + stk_code).text(cost);
            })
            .catch(error => {
                showToastError(error);
                console.log(error);
            });            
        });
        //추가 버튼 클릭
        $("#form-mystock-add").submit(function(e) {
            e.preventDefault();
            e.stopPropagation();
            const stk_code = $(this).find("input[name='stk_code']").val();
                if(stk_code.length < 6) {
                    alert("종목코드를 정확히 입력해주세요.");
                    return false;
                }
                const data = {
                    "stk_code": stk_code,
                    "stk_types": ["관심"]
                }
                postData("/api/v1/mystock/add", data)
                .then(data => {
                    display_mystocks();
                })

            return false;
        });
        // 삭제 버튼 클릭
        $('#list-area').on('click', '.btnDelete', function(e){
            e.stopPropagation();
            var id = $(this).data('id');
            fetch("/api/v1/mystock/delete/" + id, {
                method: "DELETE",
                headers: {
                    "Content-Type": "application/json"
                }
            }).then(response => response.json())
            .then(data => {
                display_mystocks();
            }).catch(error => {
                console.log(error);
            });
        })
        display_mystocks();
    });
</script>
{% endraw %}
{% endblock %}