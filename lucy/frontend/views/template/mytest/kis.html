{% extends 'common/base.html' %}
{% block style %}
<style>
    .bg-buy {
        background-color: rgb(83, 146, 241);
    }
    .bg-sell {
        background-color: #eb9999;
    }
</style>
{% endblock %}

{% block content %}
<section id="list-section" class="container">
    <h1>KIS(한국투자증권) TEST</h1>
    <button id="btnTesTToken">Test-AccessToken</button>
    <button id="btnInquireBalance">계좌잔고</button>
    <button id="btnBuySellCash">현금매수/매도</button>

    <div id="inquire-balance-area"></div>
    <div id="message-area"></div> 
</section>
<section id="buy-sell-cash-section" class="container">
    <h1>현금 매수-매도</h1>
    <div class="row">
        <div class="col bg-buy p-3">
            <h2>매수</h2>
            <form action="" id="buy-form">
                <div class="mb-3">
                    <label for="pdno" class="form-label">상품번호</label>
                    <input type="text" class="form-control" name="pdno" required>
                </div>
                <div class="mb-3">
                    <label for="qty" class="form-label">수량</label>
                    <input type="number" class="form-control" name="qty" required>
                </div>
                <button type="submit" class="btn btn-primary btnBuyCash">매수</button>
            </form>                    
        </div>
        <div class="col bg-sell p-3">
                <h2>매도</h2>
                <form action="" id="sell-form">
                    <div class="mb-3">
                        <label for="pdno" class="form-label">상품번호</label>
                        <input type="text" class="form-control" name="pdno" required>
                    </div>
                    <div class="mb-3">
                        <label for="qty" class="form-label">수량</label>
                        <input type="number" class="form-control" name="qty" required>
                    </div>
                    <button type="submit" class="btn btn-danger btnSellCash">매도</button>
                </form>                    
        </div>
    </div>
    <div id="buy-sell-message-area"></div>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>
    1 <br>

</section>

{% raw %} 
<script id="inquire-balance-table-template" type="text/x-handlebars-template">
    <h2>예수금총액 : {{displayWon output2.dnca_tot_amt}}</h2>
    <table class="table">
        <thead>
            <tr>
                <th>상품번호</th>
                <th>상품명</th>
                <th class="text-end">매입평균가격</th>
                <th class="text-end">현재가</th>
                <th class="text-end">보유수량</th>
                <th class="text-end">매입금액</th>
                <th class="text-end">평가금액</th>
                <th class="text-end">평가손익율</th>
            </tr>
        </thead>
        <tbody>
            {{#each list}}
            <tr>
                <td>{{pdno}}</td>
                <td>{{prdt_name}}</td=>
                <td class="text-end">{{displayWon pchs_avg_pric}}</td>
                <td class="text-end">{{displayWon prpr}}</td>
                <td class="text-end">{{hldg_qty}}</td>
                <td class="text-end">{{displayWon pchs_amt}}</td>
                <td class="text-end">{{displayWon evlu_amt}}</td>
                <td class="text-end">{{displayWon evlu_pfls_amt}}</td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>
{% endraw %}
{% endblock %}

{% block script %}
{% raw %}
<script>
    function initalize() {
        fetchData('/api/v1/kis')
          .then(data => { 
            if(data.rt_cd == "1"){
                console.log(data); 
                $('#message-area').html(data.msg1)
                return;
            }
            let output1 = data.output1;
            let output2 = data.output2[0];
            let template = Handlebars.compile(document.getElementById('inquire-balance-table-template').innerHTML);
            let html = template({list : output1, output2: output2});
            $('#inquire-balance-area').html(html)
            console.log(data); 
          })
          .catch(error=> { console.error(error); });
    }
    function order_cash(data){
        postData('/api/v1/kis/order_cash', data)
        .then(data => {
            console.log(data);
            alert(data.msg1)
            window.location.href = '/mytest/kis';
        }).catch(error => {
            console.error(error);
            $('#buy-sell-message-area').html(error)
        });

    }
    $( document ).ready(function() {
        console.log('ready.... ');
        $('#btnTesTToken').on('click', function() {
            console.log('btnTesTToken click.... ');

            fetchData('/api/v1/kis/token')
            .then(data => {
                console.log(data);
                $('#message-area').html(data.detail)
            }).catch(error => {
                console.error(error);
                $('#message-area').html(error)
            });
        });
        $('#buy-form').on('submit', function(e){
            e.preventDefault();
            console.log('click 매수.... ');
            const stk_code = $('#buy-form input[name=pdno]').val();
            const qty = $('#buy-form input[name=qty]').val();
            const data = {
                buy_sell_gb : '매수',
                stk_code: stk_code,
                qty: Number(qty)
                }
            order_cash(data);

        });
        $('#sell-form').on('submit', function(e){
            e.preventDefault();
            console.log('click 매도.... ');
            const stk_code = $('#sell-form input[name=pdno]').val();
            const qty = $('#sell-form input[name=qty]').val();
            const data = {
                buy_sell_gb : '매도',
                stk_code: stk_code,
                qty: Number(qty)
            }
            order_cash(data);
        })
        initalize();

    });
    </script>	    
{% endraw %}
{% endblock %}