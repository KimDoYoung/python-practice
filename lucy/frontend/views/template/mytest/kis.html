{% extends 'common/base.html' %}
{% block style %}
<style>

</style>
{% endblock %}

{% block content %}
<section id="list-section" class="container">
    <h1>KIS(한국투자증권) TEST</h1>
    <button id="btnTesTToken">Test-AccessToken</button>
    <button id="btnPsearchTitle">조건식리스트</button>
    <button id="btnInquireDailyCcld">주식일별주문체결조회</button>
    <div id="message-area"></div> 
    <div id="inquire-balance-area"></div>
</section>
<section id="buy-sell-cash-section" class="container">
    <h1>현금 매수-매도</h1>
    <div class="row">
        <div class="col bg-buy p-3 me-3">
            <h2>매수</h2>
            <form action="" id="buy-form">
                <div class="row mb-3">
                    <div class="col">
                        <label for="pdno" class="form-label">상품번호</label>
                        <input type="text" class="form-control" name="pdno" required>
                    </div>
                    <div class="col">
                        <label for="pdno" class="form-label">상품명칭</label>
                        <input type="text" class="form-control" name="pdnm" readonly required>
                    </div>
                </div>
                <div class="row mb-3">
                    <div class="col">
                        <label for="qty" class="form-label">수량</label>
                        <input type="number" class="form-control" name="qty" required min="1">
                    </div>
                    <div class="col">
                        <label for="cost" class="form-label">지정가</label>
                        <input type="number" class="form-control" name="cost" required min="0">
                    </div>
                </div>
                <button type="submit" class="btn btn-primary  btnBuyCash">매수</button>
                <button type="button" class="btn btn-secondary btnClearBuy">초기화</button>
            </form>                    
        </div>
        <div class="col bg-sell p-3">
                <h2>매도</h2>
                <form action="" id="sell-form">
                    <div class="row mb-3">
                        <div class="col">
                            <label for="pdno" class="form-label">상품번호</label>
                            <input type="text" class="form-control" name="pdno" required>
                        </div>
                        <div class="col">
                            <label for="pdno" class="form-label">상품명칭</label>
                            <input type="text" class="form-control" name="pdnm" readonly required>
                        </div>
                    </div>
                    <div class="row mb-3">
                        <div class="col">
                            <label for="qty" class="form-label">수량</label>
                            <input type="number" class="form-control" name="qty"  min="1" required>
                        </div>
                        <div class="col">
                            <label for="cost" class="form-label">지정가</label>
                            <input type="number" class="form-control" name="cost" min="0" required>
                        </div>
                    </div>
                    <button type="submit" class="btn btn-danger btnSellCash">매도</button>
                    <button type="button" class="btn btn-secondary btnClearSell">초기화</button>
                </form>                    
        </div>
    </div>
    <div id="buy-sell-message-area"></div>
    <br><br><br><br><br><br><br><br><br><br><br><br>
    
</section>

{% raw %} 
<script id="inquire-balance-table-template" type="text/x-handlebars-template">
    <h2>예수금총액 : {{displayWon output2.dnca_tot_amt}}</h2>
    <table class="table">
        <thead>
            <tr>
                <th>상품번호</th>
                <th>상품명</th>
                <th class="text-end">매입평균가격</th>
                <th class="text-end">현재가</th>
                <th class="text-end">보유수량</th>
                <th class="text-end">매입금액</th>
                <th class="text-end">평가금액</th>
                <th class="text-end">평가손익율</th>
            </tr>
        </thead>
        <tbody>
            {{#each list}}
            <tr>
                <td><a href="#" class="btnSetSellBuy" data-stk-code="{{pdno}}" data-stk-name="{{prdt_name}}">{{pdno}}</a></td>
                <td><a href="#" class="btnStockInfo" data-stk-code="{{pdno}}">{{prdt_name}}</a></td>
                <td class="text-end">{{displayWon pchs_avg_pric}}</td>
                <td class="text-end">{{displayWon prpr}}</td>
                <td class="text-end">{{hldg_qty}}</td>
                <td class="text-end">{{displayWon pchs_amt}}</td>
                <td class="text-end">{{displayWon evlu_amt}}</td>
                <td class="text-end">{{displayWon evlu_pfls_amt}}</td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>
{% endraw %}
{% endblock %}

{% block script %}
{% raw %}
<script>
    function initalize() {
        fetchData('/api/v1/kis')
          .then(data => { 
            if(data.rt_cd == "1"){
                console.log(data); 
                $('#message-area').html(data.msg1)
                return;
            }
            let output1 = data.output1;
            let output2 = data.output2[0];
            let template = Handlebars.compile(document.getElementById('inquire-balance-table-template').innerHTML);
            let html = template({list : output1, output2: output2});
            $('#inquire-balance-area').html(html)
            console.log(data); 
          })
          .catch(error=> { console.error(error); });
    }
    function order_cash(data){
        postData('/api/v1/kis/order_cash', data)
        .then(data => {
            console.log(data);
            alert(data.msg1)
            window.location.href = '/page?id=mytest_kis';
        }).catch(error => {
            console.error(error);
            $('#buy-sell-message-area').html(error)
        });

    }
    $( document ).ready(function() {
        console.log('ready.... ');
        //조건식 목록 조회
        $('#btnPsearchTitle').on('click', function() {
            window.location.href = '/page?id=mytest_kis-psearch';            
        });

        $('#inquire-balance-area').on("click", ".btnStockInfo", function(e) {
            e.preventDefault();
            const stk_code = $(this).data('stk-code');
            setCookie('stk_code', stk_code, 5);
            window.location.href = '/page?id=mytest_kis-stock-info';
            
        });
        
        //매수 매도 폼 초기화
        $('#buy-form').on("click", ".btnClearBuy", function(e) {
            e.preventDefault();
            $('#buy-form input').val('');
        });
        $('#sell-form').on("click", ".btnClearSell", function(e) {
            e.preventDefault();
            $('#sell-form input').val('');
        });
        //매수, 매도 상품번호 설정
        $('#inquire-balance-area').on("click", ".btnSetSellBuy", function(e) {
            e.preventDefault();
            const stk_code = $(this).data('stk-code');
            const stk_name = $(this).data('stk-name');
            $('#buy-form input[name=pdno]').val(stk_code);
            $('#sell-form input[name=pdno]').val(stk_code);
            $('#buy-form input[name=pdnm]').val(stk_name);
            $('#sell-form input[name=pdnm]').val(stk_name);
            $('#buy-form input[name=qty]').val(1)
            $('#sell-form input[name=qty]').val(1)
            $('#buy-form input[name=cost]').val(0)
            $('#sell-form input[name=cost]').val(0)
        });
        //
        $('#btnTesTToken').on('click', function() {
            console.log('btnTesTToken click.... ');

            fetchData('/api/v1/kis/token')
            .then(data => {
                console.log(data);
                $('#message-area').html(data.detail)
            }).catch(error => {
                console.error(error);
                $('#message-area').html(error)
            });
        });
        //매수
        $('#buy-form').on('submit', function(e){
            e.preventDefault();
            console.log('click 매수.... ');
            const stk_code = $('#buy-form input[name=pdno]').val();
            const qty = $('#buy-form input[name=qty]').val();
            const cost = $('#buy-form input[name=cost]').val();
            let msg = '';
            if( cost == 0){
                msg = '시장가로 매수하시겠습니까?';
            }else{
                msg = `지정가 ${cost}로 매수하시겠습니까?`;
            }
            if(!confirm(msg)) return;
            
            const data = {
                buy_sell_gb : '매수',
                stk_code: stk_code,
                qty: Number(qty),
                cost: Number(cost)
                }
            order_cash(data);

        });
        //매도
        $('#sell-form').on('submit', function(e){
            e.preventDefault();
            console.log('click 매도.... ');
            
            const stk_code = $('#sell-form input[name=pdno]').val();
            const qty = $('#sell-form input[name=qty]').val();
            const cost = $('#sell-form input[name=cost]').val();
            let msg = '';
            if( cost == 0){
                msg = '시장가로 매도하시겠습니까?';
            }else{
                msg = `지정가 ${cost}로 매도하시겠습니까?`;
            }        
            if(!confirm(msg)) return;    
            const data = {
                buy_sell_gb : '매도',
                stk_code: stk_code,
                qty: Number(qty),
                cost: Number(cost)
            }
            order_cash(data);
        })
        //주식일별주문체결조회
        $('#btnInquireDailyCcld').on('click', function() {
            console.log('주식일별주문체결조회 click.... ');
            window.location.href = '/page?id=mytest_kis-inquire-daily-ccld';

        });

        initalize();

    });
    </script>	    
{% endraw %}
{% endblock %}