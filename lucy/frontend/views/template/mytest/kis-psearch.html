{% extends 'common/base.html' %}
{% block style %}
<style>
</style>
{% endblock %}

{% block content %}
<section id="list" class="container">
    <h2>조건식리스트</h2>
    <div id="psearch-table-area"></div>
    <div id="psearch-reuslt-area"></div>
</section>
    
{% raw %} 
<script id="psearch-table-template" type="text/x-handlebars-template">
    <table class="table">
        <thead>
            <tr>
                <!-- {
                    "user_id": "kdy8017",
                    "seq": "0",
                    "grp_nm": "임시그룹",
                    "condition_nm": "변동성0"
                }                 -->
                <th>사용자ID</th>
                <th>그룹명</th>
                <th>조건식 명칭</th>
            </tr>
        </thead>
        <tbody>
            {{#each list}}
            <tr>
                <td>{{this.user_id}}</td>
                <td>{{this.grp_nm}}</td>
                <td><a href="#" data-seq="{{this.seq}}" class="btnPsearchResult">{{this.condition_nm}}</a></td>
            </tr>
            {{/each}}
        </tbody>
    </table>
</script>
<script id="result-table-template" type="text/x-handlebars-template">
    <div class="row">
        {{#each list}}
        <div class="col-md-4 mb-4">
          <div class="card">
            <div class="card-body">
              <h5 class="card-title text-primary">{{this.name}}</h5>
              <p class="card-text"><strong>종목코드:</strong> {{this.code}} <strong>전일대비부호:</strong> {{this.daebi}}</p>
              <p class="card-text"><strong>전일대비부호:</strong> {{this.daebi}}</p>
              <p class="card-text"><strong>현재가:</strong> {{this.price}}</p>
              <p class="card-text"><strong>등락율:</strong> {{this.chgrate}}</p>
              <p class="card-text"><strong>거래량:</strong> {{this.acml_vol}}</p>
              <p class="card-text"><strong>거래대금:</strong> {{this.trade_amt}}</p>
              <p class="card-text"><strong>전일대비:</strong> {{this.change}}</p>
              <p class="card-text"><strong>체결강도:</strong> {{this.cttr}}</p>
              <p class="card-text"><strong>시가:</strong> {{this.open}}</p>
              <p class="card-text"><strong>고가:</strong> {{this.high}}</p>
              <p class="card-text"><strong>저가:</strong> {{this.low}}</p>
              <p class="card-text"><strong>52주최고가:</strong> {{this.high52}}</p>
              <p class="card-text"><strong>52주최저가:</strong> {{this.low52}}</p>
              <!-- <p class="card-text"><strong>예상체결가:</strong> {{this.expprice}}</p>
              <p class="card-text"><strong>예상대비:</strong> {{this.expchange}}</p>
              <p class="card-text"><strong>예상등락률:</strong> {{this.expchggrate}}</p>
              <p class="card-text"><strong>예상체결수량:</strong> {{this.expcvol}}</p>
              <p class="card-text"><strong>전일거래량대비율:</strong> {{this.chgrate2}}</p>
              <p class="card-text"><strong>예상대비부호:</strong> {{this.expdaebi}}</p>
              <p class="card-text"><strong>기준가:</strong> {{this.recprice}}</p>
              <p class="card-text"><strong>상한가:</strong> {{this.uplmtprice}}</p>
              <p class="card-text"><strong>하한가:</strong> {{this.dnlmtprice}}</p> -->
              <p class="card-text"><strong>시가총액:</strong> {{this.stotprice}}</p>
            </div>
          </div>
        </div>
        {{/each}}
      </div>    
</script>
{% endraw %}
{% endblock %}

{% block script %}
{% raw %}
<script>
    function make_result_html(data){
        const rt_cd = data.rt_cd
        if(rt_cd == '1') {
            $('#psearch-reuslt-area').html(data.msg1)
            return
        }
        let template = Handlebars.compile(document.getElementById('result-table-template').innerHTML);
        let html = template({list : data.output2});
        $('#psearch-reuslt-area').html(html)

    }
    $( document ).ready(function() {
        const stk_code = $('#stk_code').val();
        fetchData('/api/v1/kis/psearch/title')
          .then(data => { 
            console.log(data);
            let template = Handlebars.compile(document.getElementById('psearch-table-template').innerHTML); 
            const output2 = data.output2;
            let html = template({list : output2});
            $('#psearch-table-area').html(html)
          })
          .catch(error=> { console.error(error); })
        $('#psearch-table-area').on("click", ".btnPsearchResult", function() {
            const seq = $(this).data('seq');
            fetchData('/api/v1/kis/psearch/result/'+seq)
              .then(data => { 
                console.log(data);
                make_result_html(data)
               })
              .catch(error=> { console.error(error); });
        });
    });
    </script>	    
{% endraw %}
{% endblock %}