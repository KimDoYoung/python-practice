{% extends 'common/base.html' %}
{% block style %}
{% endblock %}
{% block content %}
<div>
    <h1>주달검색</h1>
    <div id="search-area">
        <div id="themes-area" class="d-flex flex-wrap"></div>
        <div id="marget-area"> 
            <div id="market-radio" class="btn-group" role="group" aria-label="Market Radio Buttons">
                <input type="radio" class="btn-check" name="market" id="radio-all" autocomplete="off" checked value="all">
                <label class="btn btn-outline-primary" for="radio-all">전체</label>

                <input type="radio" class="btn-check" name="market" id="radio-kosdaq" autocomplete="off" value="KOSDAQ">
                <label class="btn btn-outline-primary" for="radio-kosdaq">코스닥</label>

                <input type="radio" class="btn-check" name="market" id="radio-kospi" autocomplete="off" value="KOSPI">
                <label class="btn btn-outline-primary" for="radio-kospi">코스피</label>
            </div>
        </div>
        <div id="cost-area" class="d-flex flex-wrap">
            <div>
                <label for="total-cost">시가총액:</label>
                <input type="number" id="total-cost" class="form-control" value="5000" required>
            </div>
            <div>
                <label for="current-cost-start">현재가:</label>
                <input type="number" id="current-cost-start" class="form-control" value="1000" required>
                <input type="number" id="current-cost-end" class="form-control" value="250000" required>
            </div>
        </div>
        <div id="search-button-area">
            <button id="search-button" class="btn btn-primary">검색</button>
        </div>
    </div>
    <div id="result-area"></div>
</div>
{% raw %}
<!--handlebar scripts-->
<script id="themes-template" type="text/x-handlebars-template">
    {{#each themes}}
    <div class="form-check me-2">
        <input class="form-check-input theme" type="checkbox" value="{{name}}" id="theme-{{@index}}">
        <label class="form-check-label" for="theme-{{@index}}">
            {{name}}
        </label>
    </div>
    {{/each}}
</script>    
<script id="themes-result-template" type="text/x-handlebars-template">
<table>
    <thead>
        <th>종목명</th>
        <th>종목코드</th>
        <th>시가총액</th>
        <th>현재가</th>
        <th>시장</th>
        <th>관련테마</th>
    </thead>
    <tbody>
        {{#each stocks}}
        <tr>
            <td>{{종목명}}</td>
            <td>{{종목코드}}</td>
            <td>{{시가총액}}</td>
            <td>{{현재가}}</td>
            <td>{{시장종류}}</td>
            <td>{{관련테마}}</td>
        </tr>
        {{/each}}
    </tbody>
</table>
</script>
{% endraw %}
{% endblock %}
{% block script %}
{% raw %}
<script>
function initialize(){
    getFetch('/api/v1/judal/themes').then(data => {
        console.log(data); 
        //테마 체크박스 만들기
        const source = document.getElementById("themes-template").innerHTML;
        const template = Handlebars.compile(source);
        const html = template({themes:data});
        $('#themes-area').html(html);
    }).catch(error=> {
        console.error(error.message); 
    });
}
function themes2badgeshtml(themeString) {
            // 주어진 문자열을 스페이스로 분리
            const themes = themeString.split(' ');

            // 각 테마를 뱃지 HTML로 변환하여 합침
            const badgesHtml = themes.map(theme => {
                return `<span class="badge bg-primary me-1">${theme}</span>`;
            }).join('');

            // HTML 문자열 반환
            return badgesHtml;
} 
$(document).ready(function() {
    console.log("Document is ready!");
    $('#search-button').on('click', function(){
        const url = '/api/v1/judal/search';
        const themes = $('#search-area').find('.theme:checked').map(function(){
            return $(this).val();
        }).get();
        if(themes.length == 0){
            alert("테마를 선택해주세요.");
            return;
        }
        let market = $('#search-area').find('.btn-check:checked').val();
        let totalCost = $('#total-cost').val();
        let currentCostStart = $('#current-cost-start').val();
        let currentCostEnd = $('#current-cost-end').val();
        
        totalCost = parseInt(totalCost, 10);
        currentCostStart = parseInt(currentCostStart, 10);
        currentCostEnd = parseInt(currentCostEnd, 10);
        const data = {
            "테마목록": themes,
            "시장종류": market,
            "시가총액": totalCost,
            "현재가": [currentCostStart, currentCostEnd]
        };
        debugger;
        postFetch(url, data).then(data => {
            console.log(data);
            const source = document.getElementById("themes-result-template").innerHTML;
            const template = Handlebars.compile(source);
            const html = template({stocks:data});
            $('#result-area').html(html);
        }).catch(error=> {
            console.error(error.message);
        });
    })
    initialize();

});
</script>
{% endraw %}
{% endblock %}